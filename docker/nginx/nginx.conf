# ============================================================================
# Nginx Main Configuration - ReaderApp
# ============================================================================
# 역할: Nginx 메인 설정 (worker, events, http 기본 설정)
#
# 설정 항목:
#   - worker_processes: CPU 코어 수에 맞게 auto
#   - worker_connections: 동시 연결 수 (1024)
#   - Gzip 압축: 텍스트/JS/CSS 등 압축
#   - 로그 형식 및 경로
#
# 참고:
#   - 사이트별 설정은 /etc/nginx/conf.d/default.conf 참조
#   - Docker 환경에서는 daemon off로 실행
# ============================================================================

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# =============================================================================
# Events 설정
# =============================================================================
events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

# =============================================================================
# HTTP 설정
# =============================================================================
http {
    # MIME 타입
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # =========================================================================
    # 로그 형식
    # =========================================================================
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time';

    access_log /var/log/nginx/access.log main;

    # =========================================================================
    # 성능 최적화
    # =========================================================================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # 서버 토큰 숨김 (보안)
    server_tokens off;

    # =========================================================================
    # Gzip 압축
    # =========================================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # =========================================================================
    # 클라이언트 설정
    # =========================================================================
    # NIfTI 파일 업로드 고려 (최대 100MB)
    client_max_body_size 100M;
    client_body_buffer_size 128k;

    # =========================================================================
    # 프록시 버퍼 설정
    # =========================================================================
    proxy_buffer_size 4k;
    proxy_buffers 8 32k;
    proxy_busy_buffers_size 64k;

    # =========================================================================
    # 사이트 설정 포함
    # =========================================================================
    include /etc/nginx/conf.d/*.conf;
}
